@page "/shares/created"
@model Agora.Web.Pages.Shares.CreatedModel

<canvas class="fixed inset-0 pointer-events-none z-0" data-confetti-canvas></canvas>

<section class="relative z-10">
  <div class="max-w-3xl mx-auto">
    <div class="rounded-2xl border border-border bg-white/95 backdrop-blur-sm shadow-sm p-8 sm:p-10">
      <p class="text-xs font-medium text-terra uppercase tracking-[0.18em]">File uploaded and downloadable</p>
      <h1 class="font-display text-5xl tracking-tight mt-3">Your link is ready to send</h1>
      <p class="text-sm text-ink-muted mt-3">Send this link to your recipient. They can open the download page and download the files immediately.</p>

      <div class="mt-8 rounded-xl border border-terra-light/40 bg-terra-wash/70 p-4 sm:p-5">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
          <div class="min-w-0">
            <p class="text-xs uppercase tracking-wider text-ink-muted mb-2">Share URL</p>
            <a href="@Model.ShareUrl" target="_blank" rel="noreferrer" class="block font-display text-3xl sm:text-4xl leading-tight text-terra break-all hover:underline">@Model.ShareUrl</a>
          </div>
          <div x-data="shareReadyCopy('@Model.ShareUrl')" class="shrink-0">
            <button type="button" class="px-5 py-2.5 text-white text-sm font-medium rounded-lg transition-colors" :class="buttonClass" x-text="label" @@click="copy"></button>
          </div>
        </div>
      </div>

      <div class="mt-10 flex flex-wrap justify-end gap-3">
        <a href="/" class="px-4 py-2 border border-border bg-cream text-ink-light text-xs font-medium rounded-lg hover:bg-cream-dark/70 transition-colors">Return to dashboard</a>
        <a href="/shares/new" class="px-4 py-2 bg-ink text-white text-xs font-medium rounded-lg hover:bg-ink/90 transition-colors">Create new share</a>
      </div>
    </div>
  </div>
</section>

<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.9/dist/cdn.min.js"></script>
<script>
function shareReadyCopy(shareUrl) {
  return {
    shareUrl,
    label: 'Copy link',
    state: 'idle',
    resetTimer: null,
    get buttonClass() {
      if (this.state === 'success') return 'bg-sage hover:bg-sage';
      if (this.state === 'error') return 'bg-danger hover:bg-danger/90';
      return 'bg-terra hover:bg-terra/90';
    },
    fallbackCopy(value) {
      const input = document.createElement('textarea');
      input.value = value;
      input.setAttribute('readonly', 'readonly');
      input.style.position = 'absolute';
      input.style.left = '-9999px';
      document.body.appendChild(input);
      input.select();
      const ok = document.execCommand('copy');
      document.body.removeChild(input);
      return ok;
    },
    flash(state) {
      if (this.resetTimer) window.clearTimeout(this.resetTimer);
      this.state = state;
      this.label = state === 'success' ? 'Copied âœ“' : 'Try again';
      this.resetTimer = window.setTimeout(() => {
        this.state = 'idle';
        this.label = 'Copy link';
      }, state === 'success' ? 1300 : 1200);
    },
    async copy(event) {
      const button = event.currentTarget;
      if (!this.shareUrl) {
        this.flash('error');
        return;
      }

      try {
        if (navigator.clipboard?.writeText) {
          await navigator.clipboard.writeText(this.shareUrl);
        } else if (!this.fallbackCopy(this.shareUrl)) {
          throw new Error('copy failed');
        }

        this.flash('success');
        button.animate(
          [{ transform: 'scale(1)' }, { transform: 'scale(1.07)' }, { transform: 'scale(1)' }],
          { duration: 260, easing: 'ease-out' }
        );
      } catch {
        this.flash('error');
        button.animate(
          [{ transform: 'translateX(0)' }, { transform: 'translateX(-3px)' }, { transform: 'translateX(3px)' }, { transform: 'translateX(0)' }],
          { duration: 220, easing: 'ease-out' }
        );
      }
    }
  };
}
</script>

<script>
(() => {
  const canvas = document.querySelector('[data-confetti-canvas]');
  if (!(canvas instanceof HTMLCanvasElement)) return;
  const context = canvas.getContext('2d');
  if (!context) return;

  const colors = ['#C4663A', '#E8A17D', '#5B7A5E', '#1A1614', '#F0EBE3'];
  const pieces = [];
  const pieceCount = 160;
  const gravity = 0.18;
  let width = 0;
  let height = 0;
  let start = 0;
  const durationMs = 4200;

  const resize = () => {
    width = window.innerWidth;
    height = window.innerHeight;
    canvas.width = Math.floor(width * window.devicePixelRatio);
    canvas.height = Math.floor(height * window.devicePixelRatio);
    context.setTransform(window.devicePixelRatio, 0, 0, window.devicePixelRatio, 0, 0);
  };

  const resetPiece = (piece, fromTop) => {
    piece.x = Math.random() * width;
    piece.y = fromTop ? -20 - Math.random() * height * 0.4 : Math.random() * -height;
    piece.vx = (Math.random() - 0.5) * 2.6;
    piece.vy = 2.2 + Math.random() * 2.8;
    piece.size = 5 + Math.random() * 7;
    piece.rotation = Math.random() * Math.PI * 2;
    piece.spin = (Math.random() - 0.5) * 0.25;
    piece.color = colors[Math.floor(Math.random() * colors.length)];
  };

  const init = () => {
    pieces.length = 0;
    for (let i = 0; i < pieceCount; i += 1) {
      const piece = {};
      resetPiece(piece, false);
      pieces.push(piece);
    }
  };

  const draw = () => {
    context.clearRect(0, 0, width, height);
    for (const piece of pieces) {
      piece.x += piece.vx;
      piece.y += piece.vy;
      piece.vy += gravity * 0.02;
      piece.rotation += piece.spin;

      if (piece.y > height + 24 || piece.x < -24 || piece.x > width + 24) {
        resetPiece(piece, true);
      }

      context.save();
      context.translate(piece.x, piece.y);
      context.rotate(piece.rotation);
      context.fillStyle = piece.color;
      context.fillRect(-piece.size / 2, -piece.size / 2, piece.size, piece.size * 0.66);
      context.restore();
    }
  };

  const tick = (timestamp) => {
    if (!start) start = timestamp;
    draw();
    if (timestamp - start <= durationMs) {
      requestAnimationFrame(tick);
    } else {
      context.clearRect(0, 0, width, height);
      canvas.remove();
    }
  };

  resize();
  init();
  window.addEventListener('resize', resize, { passive: true });
  requestAnimationFrame(tick);
})();
</script>
