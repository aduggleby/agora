@page "/shares/new"
@model Agora.Web.Pages.Shares.NewModel
@{
  string FormatFileSize(long bytes)
  {
    if (bytes >= 1024L * 1024L * 1024L) return $"{bytes / (1024.0 * 1024.0 * 1024.0):F2} GB";
    if (bytes >= 1024L * 1024L) return $"{bytes / (1024.0 * 1024.0):F2} MB";
    if (bytes >= 1024L) return $"{bytes / 1024.0:F2} KB";
    return $"{bytes} B";
  }
}

<section class="mb-10">
  <h2 class="font-display text-4xl tracking-tight mb-1">Share files</h2>
  <p class="text-ink-muted text-sm mt-3 max-w-md">Upload files, tune options, and generate a share link.</p>
</section>

<section class="mb-10">
  <div class="bg-white rounded-2xl border border-border p-6">
    <form action="/api/shares" method="post" enctype="multipart/form-data" class="space-y-5" data-share-form data-max-file-size-bytes="@Model.MaxFileSizeBytes" data-max-total-upload-bytes="@Model.MaxTotalUploadBytes">
      <div>
        <label class="text-xs font-medium text-ink-muted uppercase tracking-wider mb-1.5 block">Files</label>
        <input type="file" name="files" multiple accept="*/*" class="sr-only" data-file-input />
        <div class="rounded-lg border border-dashed border-border bg-cream p-5" data-dropzone>
          <div class="flex flex-wrap items-center justify-between gap-3">
            <div>
              <p class="text-sm text-ink-light">Select files and they upload immediately in the background.</p>
              <p class="text-xs text-ink-muted mt-1">You can keep filling in form details while upload progresses. Max 5 GB per file, 10 GB total.</p>
            </div>
            <button type="button" class="@(Model.StagedUploads.Count > 0 ? "px-4 py-2 bg-cream text-ink text-sm font-medium rounded-lg border border-border hover:bg-cream-dark/70 transition-colors" : "px-4 py-2 bg-terra text-white text-sm font-medium rounded-lg hover:bg-terra/90 transition-colors")" data-pick-files>@(Model.StagedUploads.Count > 0 ? "Add more files" : "Select files")</button>
          </div>
          <p class="text-xs text-ink-muted mt-3" data-upload-status>@(Model.StagedUploads.Count > 0 ? $"{Model.StagedUploads.Count} file(s) uploaded and ready." : "No files uploaded yet.")</p>
          <div class="mt-4 hidden" data-upload-hidden>
            @foreach (var upload in Model.StagedUploads)
            {
              <input type="hidden" name="uploadedFileIds" value="@upload.UploadId" data-uploaded-file-id="@upload.UploadId" />
            }
          </div>
          <ul class="mt-3 grid grid-cols-2 lg:grid-cols-4 gap-2" data-upload-list>
            @foreach (var upload in Model.StagedUploads)
            {
              <li class="relative rounded-lg border border-sage/35 bg-sage-wash px-2.5 py-1.5 min-w-0" data-upload-id="@upload.UploadId" data-upload-size-bytes="@upload.OriginalSizeBytes">
                <button type="button" class="absolute right-1 top-1 p-0.5 text-ink-muted hover:text-danger leading-none text-sm font-semibold" title="Remove file" data-upload-remove aria-label="Remove file">x</button>
                <p class="text-xs text-ink-light truncate pr-6">@upload.OriginalFileName</p>
                <p class="text-[11px] text-sage mt-0.5">Uploaded Â· @FormatFileSize(upload.OriginalSizeBytes)</p>
              </li>
            }
          </ul>
        </div>
      </div>
      <div>
        <label class="text-xs font-medium text-ink-muted uppercase tracking-wider mb-1.5 block">Message (optional)</label>
        <textarea name="message" rows="3" class="w-full px-3 py-2 text-sm border border-border rounded-lg bg-cream focus:outline-none focus:border-terra focus:ring-1 focus:ring-terra/20 transition-all resize-y"></textarea>
      </div>
      <div class="rounded-xl border border-border bg-cream/50 p-4">
        <div class="flex items-center justify-between gap-3 cursor-pointer" data-options-header role="button" tabindex="0" aria-controls="share-options-panel">
          <p class="text-xs font-medium text-ink-muted uppercase tracking-wider">Options</p>
          <button type="button" class="inline-flex items-center gap-1 text-xs text-terra hover:underline" data-options-toggle aria-expanded="false" title="Show or hide share options">
            <span data-options-toggle-label>Show options</span>
            <svg data-options-icon class="w-3 h-3 transition-transform" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 9l6 6 6-6"></path>
            </svg>
          </button>
        </div>
        <div id="share-options-panel" class="mt-4 hidden" data-options-panel>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label class="text-xs font-medium text-ink-muted uppercase tracking-wider mb-1.5 block">Share link</label>
              <div class="flex items-stretch rounded-lg border border-border overflow-hidden bg-cream">
                <span class="px-3 py-2 text-sm text-ink-muted bg-cream-dark/70 border-r border-border whitespace-nowrap select-none">@Model.ShareLinkPrefix</span>
                <input name="shareToken" value="@Model.ShareToken" class="flex-1 px-3 py-2 text-sm bg-cream focus:outline-none focus:ring-1 focus:ring-terra/20 transition-all font-mono" maxlength="64" minlength="3" pattern="[A-Za-z0-9_-]+" autocomplete="off" spellcheck="false" data-share-token />
              </div>
              <p class="text-[11px] text-ink-muted mt-1">3-64 letters, numbers, hyphens, or underscores. Default links use 8 characters.</p>
              @if (!string.IsNullOrWhiteSpace(Model.SuggestedShareToken))
              {
                <p class="text-[11px] text-danger mt-1.5">
                  That link is already in use.
                  <button type="button" class="underline hover:no-underline ml-1" data-suggested-share-token="@Model.SuggestedShareToken">Use @Model.SuggestedShareToken</button>
                </p>
              }
            </div>
            <div>
              <label class="text-xs font-medium text-ink-muted uppercase tracking-wider mb-1.5 block">Zip filename</label>
              <input name="zipFileName" class="w-full px-3 py-2 text-sm border border-border rounded-lg bg-cream focus:outline-none focus:border-terra focus:ring-1 focus:ring-terra/20 transition-all" placeholder="Auto-generated if blank" />
            </div>
            <div>
              <label class="text-xs font-medium text-ink-muted uppercase tracking-wider mb-1.5 block">Download password (optional)</label>
              <input type="password" name="downloadPassword" minlength="8" maxlength="256" autocomplete="new-password" class="w-full px-3 py-2 text-sm border border-border rounded-lg bg-cream focus:outline-none focus:border-terra focus:ring-1 focus:ring-terra/20 transition-all" placeholder="At least 8 characters" />
              <p class="text-[11px] text-ink-muted mt-1">Files will be encrypted and password must be entered to download/view.</p>
            </div>
            <div>
              <label class="text-xs font-medium text-ink-muted uppercase tracking-wider mb-1.5 block">Previews</label>
              <label class="flex items-start gap-3 p-3 border border-border rounded-xl bg-cream">
                <input type="checkbox" name="showPreviews" value="1" class="mt-0.5 h-4 w-4 accent-terra" />
                <span class="block">
                  <span class="block text-sm text-ink font-normal">Allow viewing file contents before downloading</span>
                </span>
              </label>
            </div>
            <div>
              <label class="text-xs font-medium text-ink-muted uppercase tracking-wider mb-1.5 block">Download notifications</label>
              <select name="notifyMode" class="w-full px-3 py-2 text-sm border border-border rounded-lg bg-cream focus:outline-none focus:border-terra focus:ring-1 focus:ring-terra/20 transition-all appearance-none">
                <option value="account_default" selected>Account default (@Model.AccountDefaultNotifyModeLabel)</option>
                <option value="none">None</option>
                <option value="once">First download only</option>
                <option value="every_time">Every download</option>
              </select>
            </div>
            <div>
              <label class="text-xs font-medium text-ink-muted uppercase tracking-wider mb-1.5 block">Expiry mode</label>
              <select name="expiryMode" class="w-full px-3 py-2 text-sm border border-border rounded-lg bg-cream focus:outline-none focus:border-terra focus:ring-1 focus:ring-terra/20 transition-all appearance-none">
                <option value="account_default" selected>Account default (@Model.AccountDefaultExpiryModeLabel)</option>
                <option value="1_hour">1 hour</option>
                <option value="24_hours">24 hours</option>
                <option value="7_days">7 days</option>
                <option value="30_days">30 days</option>
                <option value="1_year">1 year</option>
                <option value="date">Date</option>
                <option value="indefinite">Indefinite</option>
              </select>
              <input type="hidden" value="@Model.AccountDefaultExpiryMode" data-account-default-expiry-mode />
            </div>
            <div>
              <label class="text-xs font-medium text-ink-muted uppercase tracking-wider mb-1.5 block">Expires at (local time)</label>
              <input type="datetime-local" name="expiresAtUtc" class="w-full px-3 py-2 text-sm border border-border rounded-lg bg-cream focus:outline-none focus:border-terra focus:ring-1 focus:ring-terra/20 transition-all" />
            </div>
            <div>
              <label class="text-xs font-medium text-ink-muted uppercase tracking-wider mb-1.5 block">Download page design</label>
              <select name="templateMode" class="w-full px-3 py-2 text-sm border border-border rounded-lg bg-cream focus:outline-none focus:border-terra focus:ring-1 focus:ring-terra/20 transition-all appearance-none" data-template-mode>
                <option value="account_default" selected="@(Model.TemplateModeForDraft == "account_default")">Account default</option>
                <option value="per_upload" selected="@(Model.TemplateModeForDraft == "per_upload")">Custom for this share</option>
              </select>
            </div>
            <div class="@(Model.TemplateModeForDraft == "per_upload" ? string.Empty : "hidden")" data-template-custom-actions>
              <label class="text-xs font-medium text-ink-muted uppercase tracking-wider mb-1.5 block">Custom design</label>
              <a href="/share/landing-page-designer?draftShareId=@Model.DraftShareId" class="inline-block px-4 py-2 bg-ink text-white text-sm font-medium rounded-lg hover:bg-ink/90 transition-colors" data-template-designer-link>Change design</a>
            </div>
          </div>
        </div>
      </div>

      <input type="hidden" name="draftShareId" value="@Model.DraftShareId" data-draft-share-id />
      <input type="hidden" name="template.title" value="@Model.DraftTemplate.Title" data-template-title />
      <input type="hidden" name="template.h1" value="@Model.DraftTemplate.H1" data-template-h1 />
      <input type="hidden" name="template.description" value="@Model.DraftTemplate.Description" data-template-description />
      <input type="hidden" name="template.backgroundUploadId" value="@Model.DraftTemplate.BackgroundUploadId" data-template-background-upload-id />
      <input type="hidden" name="template.backgroundColorHex" value="@Model.DraftTemplate.BackgroundColorHex" data-template-background-color-hex />
      <input type="hidden" name="template.containerPosition" value="@Model.DraftTemplate.ContainerPosition" data-template-container-position />

      <div class="hidden rounded-lg border border-border bg-cream/60 px-4 py-3 text-sm text-ink-light" data-submit-pending role="status" aria-live="polite">
        <div class="flex items-center gap-2">
          <span class="inline-block h-4 w-4 animate-spin rounded-full border-2 border-terra/30 border-t-terra" aria-hidden="true"></span>
          <span>Preparing your link...</span>
        </div>
        <p class="mt-2 text-xs text-ink-muted">You can leave this page or wait. We will email you when your link is ready.</p>
      </div>

      <div class="flex justify-end">
        <button type="submit" class="px-6 py-2.5 bg-terra text-white text-sm font-medium rounded-lg hover:bg-terra/90 transition-colors disabled:opacity-60 disabled:cursor-not-allowed" data-submit>Create share link</button>
      </div>
    </form>

    <dialog class="rounded-xl border border-border bg-white p-0 w-full max-w-sm backdrop:bg-black/30 m-auto" style="margin: auto;" data-upload-remove-dialog>
      <form method="dialog" class="p-5">
        <h3 class="font-display text-2xl tracking-tight">Remove file?</h3>
        <p class="text-sm text-ink-muted mt-2">This only removes the staged file from this draft share.</p>
        <p class="text-sm text-ink-light mt-2" data-upload-remove-file-name></p>
        <div class="mt-5 flex justify-end gap-2">
          <button type="button" class="px-4 py-2 text-sm border border-border rounded-lg bg-cream hover:bg-cream-dark/70" data-upload-remove-cancel>Cancel</button>
          <button type="button" class="px-4 py-2 text-sm bg-danger text-white rounded-lg hover:bg-danger/90" data-upload-remove-confirm>Remove</button>
        </div>
      </form>
    </dialog>
  </div>
</section>

<script src="/js/shares-new.js"></script>
