@page "/shares/new"
@model Agora.Web.Pages.Shares.NewModel

<section class="mb-10">
  <h2 class="font-display text-4xl tracking-tight mb-1">Share files</h2>
  <p class="text-ink-muted text-sm mt-3 max-w-md">Upload files, tune options, and generate a share link.</p>
</section>

<section class="mb-10">
  <div class="bg-white rounded-2xl border border-border p-6">
    <form action="/api/shares" method="post" enctype="multipart/form-data" class="space-y-5" data-share-form>
      <div>
        <label class="text-xs font-medium text-ink-muted uppercase tracking-wider mb-1.5 block">Files</label>
        <input type="file" name="files" multiple class="sr-only" data-file-input />
        <div class="rounded-lg border border-dashed border-border bg-cream p-5" data-dropzone>
          <div class="flex flex-wrap items-center justify-between gap-3">
            <div>
              <p class="text-sm text-ink-light">Select files and they upload immediately in the background.</p>
              <p class="text-xs text-ink-muted mt-1">You can keep filling in form details while upload progresses.</p>
            </div>
            <button type="button" class="px-4 py-2 bg-terra text-white text-sm font-medium rounded-lg hover:bg-terra/90 transition-colors" data-pick-files>Select files</button>
          </div>
          <p class="text-xs text-ink-muted mt-3" data-upload-status>@(Model.StagedUploads.Count > 0 ? $"{Model.StagedUploads.Count} file(s) uploaded and ready." : "No files uploaded yet.")</p>
          <div class="mt-4 hidden" data-upload-hidden>
            @foreach (var upload in Model.StagedUploads)
            {
              <input type="hidden" name="uploadedFileIds" value="@upload.UploadId" data-uploaded-file-id="@upload.UploadId" />
            }
          </div>
          <ul class="mt-3 grid grid-cols-2 lg:grid-cols-4 gap-2" data-upload-list>
            @foreach (var upload in Model.StagedUploads)
            {
              <li class="relative rounded-lg border border-sage/35 bg-sage-wash px-2.5 py-1.5 min-w-0" data-upload-id="@upload.UploadId">
                <button type="button" class="absolute right-1 top-1 p-0.5 text-ink-muted hover:text-danger leading-none text-sm font-semibold" title="Remove file" data-upload-remove aria-label="Remove file">x</button>
                <p class="text-xs text-ink-light truncate">@upload.OriginalFileName</p>
                <p class="text-[11px] text-sage mt-0.5">Uploaded</p>
              </li>
            }
          </ul>
        </div>
      </div>
      <div>
        <label class="text-xs font-medium text-ink-muted uppercase tracking-wider mb-1.5 block">Message (optional)</label>
        <textarea name="message" rows="3" class="w-full px-3 py-2 text-sm border border-border rounded-lg bg-cream focus:outline-none focus:border-terra focus:ring-1 focus:ring-terra/20 transition-all resize-y"></textarea>
      </div>
      <div class="rounded-xl border border-border bg-cream/50 p-4">
        <div class="flex items-center justify-between gap-3 cursor-pointer" data-options-header role="button" tabindex="0" aria-controls="share-options-panel">
          <p class="text-xs font-medium text-ink-muted uppercase tracking-wider">Options</p>
          <button type="button" class="inline-flex items-center gap-1 text-xs text-terra hover:underline" data-options-toggle aria-expanded="false" title="Show or hide share options">
            <span data-options-toggle-label>Show options</span>
            <svg data-options-icon class="w-3 h-3 transition-transform" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 9l6 6 6-6"></path>
            </svg>
          </button>
        </div>
        <div id="share-options-panel" class="mt-4 hidden" data-options-panel>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label class="text-xs font-medium text-ink-muted uppercase tracking-wider mb-1.5 block">Share link</label>
              <div class="flex items-stretch rounded-lg border border-border overflow-hidden bg-cream">
                <span class="px-3 py-2 text-sm text-ink-muted bg-cream-dark/70 border-r border-border whitespace-nowrap select-none">@Model.ShareLinkPrefix</span>
                <input name="shareToken" value="@Model.ShareToken" class="flex-1 px-3 py-2 text-sm bg-cream focus:outline-none focus:ring-1 focus:ring-terra/20 transition-all font-mono" maxlength="64" minlength="3" pattern="[A-Za-z0-9]+" autocomplete="off" spellcheck="false" data-share-token />
              </div>
              <p class="text-[11px] text-ink-muted mt-1">3-64 letters or numbers. Default links use 8 characters.</p>
              @if (!string.IsNullOrWhiteSpace(Model.SuggestedShareToken))
              {
                <p class="text-[11px] text-danger mt-1.5">
                  That link is already in use.
                  <button type="button" class="underline hover:no-underline ml-1" data-suggested-share-token="@Model.SuggestedShareToken">Use @Model.SuggestedShareToken</button>
                </p>
              }
            </div>
            <div>
              <label class="text-xs font-medium text-ink-muted uppercase tracking-wider mb-1.5 block">Zip filename</label>
              <input name="zipFileName" class="w-full px-3 py-2 text-sm border border-border rounded-lg bg-cream focus:outline-none focus:border-terra focus:ring-1 focus:ring-terra/20 transition-all" placeholder="Auto-generated if blank" />
            </div>
            <div>
              <label class="text-xs font-medium text-ink-muted uppercase tracking-wider mb-1.5 block">Download notifications</label>
              <select name="notifyMode" class="w-full px-3 py-2 text-sm border border-border rounded-lg bg-cream focus:outline-none focus:border-terra focus:ring-1 focus:ring-terra/20 transition-all appearance-none">
                <option value="account_default" selected>Account default (@Model.AccountDefaultNotifyModeLabel)</option>
                <option value="none">None</option>
                <option value="once">First download only</option>
                <option value="every_time">Every download</option>
              </select>
            </div>
            <div>
              <label class="text-xs font-medium text-ink-muted uppercase tracking-wider mb-1.5 block">Expiry mode</label>
              <select name="expiryMode" class="w-full px-3 py-2 text-sm border border-border rounded-lg bg-cream focus:outline-none focus:border-terra focus:ring-1 focus:ring-terra/20 transition-all appearance-none">
                <option value="account_default" selected>Account default (@Model.AccountDefaultExpiryModeLabel)</option>
                <option value="1_hour">1 hour</option>
                <option value="24_hours">24 hours</option>
                <option value="7_days">7 days</option>
                <option value="30_days">30 days</option>
                <option value="1_year">1 year</option>
                <option value="date">Date</option>
                <option value="indefinite">Indefinite</option>
              </select>
              <input type="hidden" value="@Model.AccountDefaultExpiryMode" data-account-default-expiry-mode />
            </div>
            <div>
              <label class="text-xs font-medium text-ink-muted uppercase tracking-wider mb-1.5 block">Expires at (local time)</label>
              <input type="datetime-local" name="expiresAtUtc" class="w-full px-3 py-2 text-sm border border-border rounded-lg bg-cream focus:outline-none focus:border-terra focus:ring-1 focus:ring-terra/20 transition-all" />
            </div>
            <div>
              <label class="text-xs font-medium text-ink-muted uppercase tracking-wider mb-1.5 block">Download page design</label>
              <select name="templateMode" class="w-full px-3 py-2 text-sm border border-border rounded-lg bg-cream focus:outline-none focus:border-terra focus:ring-1 focus:ring-terra/20 transition-all appearance-none" data-template-mode>
                <option value="account_default" selected="@(Model.TemplateModeForDraft == "account_default")">Account default</option>
                <option value="per_upload" selected="@(Model.TemplateModeForDraft == "per_upload")">Custom for this share</option>
              </select>
            </div>
            <div class="@(Model.TemplateModeForDraft == "per_upload" ? string.Empty : "hidden")" data-template-custom-actions>
              <label class="text-xs font-medium text-ink-muted uppercase tracking-wider mb-1.5 block">Custom design</label>
              <a href="/share/landing-page-designer?draftShareId=@Model.DraftShareId" class="inline-block px-4 py-2 bg-ink text-white text-sm font-medium rounded-lg hover:bg-ink/90 transition-colors" data-template-designer-link>Change design</a>
            </div>
          </div>
        </div>
      </div>

      <input type="hidden" name="draftShareId" value="@Model.DraftShareId" data-draft-share-id />
      <input type="hidden" name="template.title" value="@Model.DraftTemplate.Title" data-template-title />
      <input type="hidden" name="template.h1" value="@Model.DraftTemplate.H1" data-template-h1 />
      <input type="hidden" name="template.description" value="@Model.DraftTemplate.Description" data-template-description />
      <input type="hidden" name="template.backgroundUploadId" value="@Model.DraftTemplate.BackgroundUploadId" data-template-background-upload-id />
      <input type="hidden" name="template.backgroundColorHex" value="@Model.DraftTemplate.BackgroundColorHex" data-template-background-color-hex />
      <input type="hidden" name="template.containerPosition" value="@Model.DraftTemplate.ContainerPosition" data-template-container-position />

      <div class="flex justify-end">
        <button type="submit" class="px-6 py-2.5 bg-terra text-white text-sm font-medium rounded-lg hover:bg-terra/90 transition-colors disabled:opacity-60 disabled:cursor-not-allowed" data-submit>Create share link</button>
      </div>
    </form>

    <dialog class="rounded-xl border border-border bg-white p-0 w-full max-w-sm backdrop:bg-black/30 m-auto" style="margin: auto;" data-upload-remove-dialog>
      <form method="dialog" class="p-5">
        <h3 class="font-display text-2xl tracking-tight">Remove file?</h3>
        <p class="text-sm text-ink-muted mt-2">This only removes the staged file from this draft share.</p>
        <p class="text-sm text-ink-light mt-2" data-upload-remove-file-name></p>
        <div class="mt-5 flex justify-end gap-2">
          <button type="button" class="px-4 py-2 text-sm border border-border rounded-lg bg-cream hover:bg-cream-dark/70" data-upload-remove-cancel>Cancel</button>
          <button type="button" class="px-4 py-2 text-sm bg-danger text-white rounded-lg hover:bg-danger/90" data-upload-remove-confirm>Remove</button>
        </div>
      </form>
    </dialog>
  </div>
</section>

<script>
(() => {
  const form = document.querySelector('[data-share-form]');
  if (!form) return;
  const fileInput = form.querySelector('[data-file-input]');
  const pickButton = form.querySelector('[data-pick-files]');
  const list = form.querySelector('[data-upload-list]');
  const hidden = form.querySelector('[data-upload-hidden]');
  const status = form.querySelector('[data-upload-status]');
  const submit = form.querySelector('[data-submit]');
  const dropzone = form.querySelector('[data-dropzone]');
  const expiryModeInput = form.querySelector('[name="expiryMode"]');
  const expiresAtInput = form.querySelector('[name="expiresAtUtc"]');
  const accountDefaultExpiryInput = form.querySelector('[data-account-default-expiry-mode]');
  const optionsToggle = form.querySelector('[data-options-toggle]');
  const optionsHeader = form.querySelector('[data-options-header]');
  const optionsToggleLabel = form.querySelector('[data-options-toggle-label]');
  const optionsToggleIcon = form.querySelector('[data-options-icon]');
  const optionsPanel = form.querySelector('[data-options-panel]');
  const shareTokenInput = form.querySelector('[data-share-token]');
  const suggestedShareTokenButton = form.querySelector('[data-suggested-share-token]');
  const draftShareIdInput = form.querySelector('[data-draft-share-id]');
  const uploadedIds = new Set();
  hidden.querySelectorAll('input[name="uploadedFileIds"]').forEach((input) => { if (input && input.value) uploadedIds.add(input.value); });
  let activeUploads = 0;
  let manualExpiryValue = '';
  const optionsStorageKey = 'agora:new-share:options-collapsed';

  const setOptionsCollapsed = (isCollapsed) => {
    if (!optionsPanel || !optionsToggle) return;
    optionsPanel.classList.toggle('hidden', isCollapsed);
    if (optionsToggleLabel) optionsToggleLabel.textContent = isCollapsed ? 'Show options' : 'Hide options';
    if (optionsToggleIcon) optionsToggleIcon.classList.toggle('rotate-180', !isCollapsed);
    optionsToggle.setAttribute('aria-expanded', (!isCollapsed).toString());
    optionsHeader?.setAttribute('aria-expanded', (!isCollapsed).toString());
  };

  const toggleOptions = () => {
    if (!optionsPanel) return;
    const nextCollapsed = !optionsPanel.classList.contains('hidden');
    setOptionsCollapsed(nextCollapsed);
    try {
      localStorage.setItem(optionsStorageKey, nextCollapsed ? 'collapsed' : 'expanded');
    } catch {
      // Ignore localStorage access errors.
    }
  };

  const toLocalDateTimeValue = (date) => {
    const pad = (n) => String(n).padStart(2, '0');
    return [
      date.getFullYear(),
      '-',
      pad(date.getMonth() + 1),
      '-',
      pad(date.getDate()),
      'T',
      pad(date.getHours()),
      ':',
      pad(date.getMinutes())
    ].join('');
  };

  const resolveEffectiveExpiryMode = () => {
    const selected = (expiryModeInput?.value || 'account_default').trim().toLowerCase();
    if (selected !== 'account_default') return selected;
    return (accountDefaultExpiryInput?.value || '7_days').trim().toLowerCase();
  };

  const computeExpiryDate = (mode, now) => {
    switch (mode) {
      case '1_hour':
        return new Date(now.getTime() + (1 * 60 * 60 * 1000));
      case '24_hours':
        return new Date(now.getTime() + (24 * 60 * 60 * 1000));
      case '7_days':
        return new Date(now.getTime() + (7 * 24 * 60 * 60 * 1000));
      case '30_days':
        return new Date(now.getTime() + (30 * 24 * 60 * 60 * 1000));
      case '1_year': {
        const d = new Date(now.getTime());
        d.setFullYear(d.getFullYear() + 1);
        return d;
      }
      default:
        return null;
    }
  };

  const syncExpiryInput = () => {
    if (!expiresAtInput) return;
    const effectiveMode = resolveEffectiveExpiryMode();
    const now = new Date();
    const isManualDate = effectiveMode === 'date';

    if (isManualDate) {
      expiresAtInput.disabled = false;
      const parsed = expiresAtInput.value ? new Date(expiresAtInput.value) : null;
      if (parsed && !Number.isNaN(parsed.getTime()) && parsed.getTime() > now.getTime()) {
        manualExpiryValue = expiresAtInput.value;
      }
      if (!manualExpiryValue) {
        manualExpiryValue = toLocalDateTimeValue(new Date(now.getTime() + (24 * 60 * 60 * 1000)));
      }
      expiresAtInput.value = manualExpiryValue;
      expiresAtInput.title = '';
      return;
    }

    if (!expiresAtInput.disabled && expiresAtInput.value) {
      manualExpiryValue = expiresAtInput.value;
    }

    expiresAtInput.disabled = true;
    const calculated = computeExpiryDate(effectiveMode, now);
    if (!calculated) {
      expiresAtInput.value = '';
      expiresAtInput.title = effectiveMode === 'indefinite'
        ? 'No expiry date for indefinite mode.'
        : 'Calculated from expiry mode.';
      return;
    }

    expiresAtInput.value = toLocalDateTimeValue(calculated);
    expiresAtInput.title = 'Calculated from expiry mode.';
  };

  const refreshState = () => {
    syncExpiryInput();
    const effectiveExpiryMode = resolveEffectiveExpiryMode();
    let reason = '';
    if (activeUploads > 0) reason = 'Please wait for uploads to finish.';
    else if (uploadedIds.size === 0) reason = 'Upload at least one file first.';
    else if (shareTokenInput) {
      const token = (shareTokenInput.value || '').trim();
      if (token.length < 3 || token.length > 64 || !/^[A-Za-z0-9]+$/.test(token)) reason = 'Share link must be 3-64 letters or numbers.';
    }
    if (!reason && effectiveExpiryMode === 'date') {
      if (!expiresAtInput.value) reason = 'Pick an expiry date and time.';
      else if (Number.isNaN(new Date(expiresAtInput.value).getTime()) || new Date(expiresAtInput.value).getTime() <= Date.now()) reason = 'Expiry date must be in the future.';
    }
    submit.disabled = reason.length > 0;
    submit.title = reason;
    status.textContent = activeUploads > 0 ? 'Uploading ' + activeUploads + ' file(s)...' : (uploadedIds.size > 0 ? uploadedIds.size + ' file(s) uploaded and ready.' : 'No files uploaded yet.');
  };

  const addHidden = (id) => {
    const i = document.createElement('input');
    i.type = 'hidden'; i.name = 'uploadedFileIds'; i.value = id; i.setAttribute('data-uploaded-file-id', id); hidden.appendChild(i);
  };
  const removeHidden = (id) => hidden.querySelectorAll('input[name="uploadedFileIds"]').forEach((i) => { if (i.value === id) i.remove(); });

  const requestRemove = (id, row) => {
    if (!id) return;
    const data = new FormData();
    data.append('uploadId', id);
    data.append('draftShareId', draftShareIdInput.value);
    fetch('/api/uploads/remove', { method: 'POST', body: data }).then((r) => {
      if (!r.ok) throw new Error();
      uploadedIds.delete(id); removeHidden(id); row?.remove(); refreshState();
    }).catch(() => { status.textContent = 'Unable to remove file right now.'; });
  };

  const createRow = (file) => {
    const row = document.createElement('li');
    row.className = 'relative rounded-lg border border-border bg-cream px-2.5 py-2 min-w-0';
    const remove = document.createElement('button');
    remove.type = 'button'; remove.className = 'absolute right-1 top-1 p-0.5 text-ink-muted hover:text-danger leading-none text-sm font-semibold hidden'; remove.textContent = 'x'; remove.title = 'Remove file';
    const name = document.createElement('p'); name.className = 'text-xs text-ink-light truncate'; name.textContent = file.name;
    const size = document.createElement('p'); size.className = 'text-[11px] text-ink-muted mt-0.5'; size.textContent = file.size + ' B';
    const barWrap = document.createElement('div'); barWrap.className = 'mt-1.5 h-1 bg-white rounded-full overflow-hidden';
    const bar = document.createElement('div'); bar.className = 'h-full bg-terra transition-all'; bar.style.width = '0%'; barWrap.appendChild(bar);
    const state = document.createElement('p'); state.className = 'text-[11px] text-ink-muted mt-1'; state.textContent = 'Queued...';
    row.append(remove, name, size, barWrap, state); list.appendChild(row);
    return { row, remove, name, size, barWrap, bar, state };
  };

  const uploadFile = (file) => {
    const ui = createRow(file); activeUploads += 1; refreshState();
    const xhr = new XMLHttpRequest(); xhr.open('POST', '/api/uploads/stage'); xhr.responseType = 'json';
    xhr.upload.addEventListener('progress', (e) => { if (!e.lengthComputable) return; const p = Math.min(100, Math.round((e.loaded / e.total) * 100)); ui.bar.style.width = p + '%'; ui.state.textContent = 'Uploading... ' + p + '%'; });
    xhr.addEventListener('load', () => {
      activeUploads -= 1;
      if (xhr.status >= 200 && xhr.status < 300 && xhr.response && xhr.response.uploadId) {
        const id = xhr.response.uploadId;
        uploadedIds.add(id); addHidden(id); ui.row.setAttribute('data-upload-id', id);
        ui.row.className = 'relative rounded-lg border border-sage/35 bg-sage-wash px-2.5 py-1.5 min-w-0';
        ui.barWrap.style.display = 'none'; ui.size.style.display = 'none'; ui.state.textContent = 'Uploaded'; ui.state.className = 'text-[11px] text-sage mt-0.5';
        ui.remove.classList.remove('hidden');
        ui.remove.addEventListener('click', () => requestRemove(id, ui.row));
      }
      refreshState();
    });
    xhr.addEventListener('error', () => { activeUploads -= 1; ui.state.textContent = 'Upload failed'; ui.state.className = 'text-[11px] text-danger mt-1'; refreshState(); });
    const data = new FormData(); data.append('draftShareId', draftShareIdInput.value); data.append('file', file, file.name); xhr.send(data);
  };

  list.querySelectorAll('[data-upload-remove]').forEach((button) => {
    button.addEventListener('click', () => {
      const row = button.closest('[data-upload-id]'); if (!row) return;
      const id = row.getAttribute('data-upload-id') || '';
      if (!id) return;
      requestRemove(id, row);
    });
  });

  pickButton?.addEventListener('click', () => fileInput.click());
  fileInput?.addEventListener('change', () => { Array.from(fileInput.files || []).forEach((f) => uploadFile(f)); fileInput.value = ''; });
  dropzone?.addEventListener('dragover', (e) => { e.preventDefault(); dropzone.classList.add('ring-2', 'ring-terra/40'); });
  dropzone?.addEventListener('dragleave', () => dropzone.classList.remove('ring-2', 'ring-terra/40'));
  dropzone?.addEventListener('drop', (e) => { e.preventDefault(); dropzone.classList.remove('ring-2', 'ring-terra/40'); Array.from(e.dataTransfer?.files || []).forEach((f) => uploadFile(f)); });

  expiryModeInput?.addEventListener('change', refreshState);
  expiresAtInput?.addEventListener('input', refreshState);
  shareTokenInput?.addEventListener('input', refreshState);
  suggestedShareTokenButton?.addEventListener('click', () => {
    if (!shareTokenInput) return;
    shareTokenInput.value = suggestedShareTokenButton.getAttribute('data-suggested-share-token') || shareTokenInput.value;
    shareTokenInput.focus();
    shareTokenInput.select();
    refreshState();
  });

  if (optionsPanel && optionsToggle) {
    let isCollapsed = true;
    try {
      const saved = localStorage.getItem(optionsStorageKey);
      if (saved === 'expanded') isCollapsed = false;
      else if (saved === 'collapsed') isCollapsed = true;
    } catch {
      // Ignore localStorage access errors.
    }

    setOptionsCollapsed(isCollapsed);
    optionsToggle.addEventListener('click', (event) => {
      event.stopPropagation();
      toggleOptions();
    });
    optionsHeader?.addEventListener('click', (event) => {
      if (event.target && event.target.closest('[data-options-toggle]')) return;
      toggleOptions();
    });
    optionsHeader?.addEventListener('keydown', (event) => {
      if (event.key !== 'Enter' && event.key !== ' ') return;
      event.preventDefault();
      toggleOptions();
    });
  }
  form.addEventListener('submit', (e) => { if (submit.disabled) e.preventDefault(); });
  refreshState();
})();
</script>
<script>
(() => {
  const form = document.querySelector('[data-share-form]'); if (!form) return;
  const summary = form.querySelector('[data-template-summary]');
  const modeInput = form.querySelector('[data-template-mode]');
  const titleInput = form.querySelector('[data-template-title]');
  const h1Input = form.querySelector('[data-template-h1]');
  const customActions = form.querySelector('[data-template-custom-actions]');
  const designerLink = form.querySelector('[data-template-designer-link]');
  const refresh = () => {
    if (modeInput.value !== 'per_upload') { if (summary) summary.textContent = 'Using account default template.'; customActions?.classList.add('hidden'); return; }
    if (summary) summary.textContent = 'Custom design selected: ' + (h1Input.value || titleInput.value || 'Untitled') + '.';
    customActions?.classList.remove('hidden');
  };
  designerLink?.addEventListener('click', (e) => { if (modeInput.value !== 'per_upload') e.preventDefault(); });
  modeInput?.addEventListener('change', refresh);
  refresh();
})();
</script>
