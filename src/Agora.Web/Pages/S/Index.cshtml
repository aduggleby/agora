@page "/s/{token}"
@model Agora.Web.Pages.S.IndexModel
@{
    Layout = null;
    var previewDownloadLabel = (Model.Share?.Files.Count ?? 0) > 1 ? "Download all files" : "Download file";
    var cardModel = new Agora.Web.Pages.Shared.ShareLandingCardViewModel(
        Title: Model.DisplayH1,
        Subtitle: Model.Share?.PageTitle,
        Description: Model.Share?.PageDescription ?? string.Empty,
        ZipDisplayName: Model.Share?.ZipDisplayName ?? string.Empty,
        FileCount: Model.Share?.Files.Count ?? 0,
        SizeDisplay: Model.SizeDisplay,
        IsExpired: Model.IsExpired,
        DownloadUrl: $"/s/{Model.Token}/download",
        IsDownloadAllowed: Model.AllowsZipDownload,
        DownloadDisabledReason: "ZIP download is disabled for this share mode.",
        RequiresPassword: Model.RequiresPassword,
        DownloadError: Model.DownloadError);
}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>@Model.DisplayH1 - Agora</title>
  <meta name="description" content="@(Model.Share?.PageDescription ?? "Download shared files")" />

  <meta property="og:type" content="website" />
  <meta property="og:title" content="@Model.DisplayH1" />
  <meta property="og:description" content="@(Model.Share?.PageDescription ?? "Download shared files")" />
  <meta property="og:image" content="@Model.OgImageUrl" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta property="og:url" content="@Model.PageUrl" />

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="@Model.DisplayH1" />
  <meta name="twitter:description" content="@(Model.Share?.PageDescription ?? "Download shared files")" />
  <meta name="twitter:image" content="@Model.OgImageUrl" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
  <style>
    :root { --cream:#FAF7F2; --ink:#1A1614; --ink-light:#5C534A; --ink-muted:#9B9189; --terra:#C4663A; --border:#E5DFD7; --cream-dark:#F0EBE3; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family:'DM Sans',sans-serif; background: var(--cream); color: var(--ink); min-height:100vh; display:flex; flex-direction:column; align-items:@Model.ContainerAlignItems; justify-content:@Model.ContainerJustifyContent; padding:2rem; @(!string.IsNullOrWhiteSpace(Model.Share?.PageBackgroundColorHex) ? $"background-color:{Model.Share.PageBackgroundColorHex};" : "") @(!string.IsNullOrWhiteSpace(Model.BackgroundImageUrl) ? $"background-image:url({Model.BackgroundImageUrl});background-size:cover;background-position:center;" : "") }

    .preview-shell { width:min(80vw,1080px); max-height:80vh; background:white; border:1px solid var(--border); border-radius:1rem; box-shadow:0 12px 38px rgba(26,22,20,0.11); display:flex; flex-direction:column; overflow:hidden; }
    .preview-header { padding:1.15rem 1.25rem; border-bottom:1px solid var(--border); background:linear-gradient(180deg,#fff 0%,#fdfaf6 100%); }
    .preview-title { font-family:'Instrument Serif',serif; font-size:1.8rem; line-height:1.06; letter-spacing:-0.01em; }
    .preview-subtitle { font-size:0.95rem; color:var(--ink-light); margin-top:0.22rem; }
    .preview-description { font-size:0.82rem; color:var(--ink-light); margin-top:0.52rem; }
    .preview-content { flex:1; min-height:0; overflow:scroll; }
    .mosaic-grid { padding:1rem; display:grid; grid-template-columns:repeat(auto-fill,minmax(145px,1fr)); gap:0.75rem; }
    .mosaic-item { border:1px solid var(--border); border-radius:0.75rem; overflow:hidden; background:#f8f4ef; position:relative; }
    .mosaic-open { display:block; text-decoration:none; }
    .mosaic-item img { width:100%; height:150px; object-fit:cover; display:block; }
    .mosaic-meta { display:flex; align-items:center; gap:0.4rem; padding:0.45rem 0.55rem; min-width:0; }
    .mosaic-label { font-size:0.7rem; line-height:1.2; color:var(--ink-light); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; min-width:0; flex:1; }
    .file-icon-download { display:inline-flex; align-items:center; justify-content:center; width:1.2rem; height:1.2rem; border-radius:999px; text-decoration:none; color:#fff; background:var(--terra); flex:0 0 auto; }
    .file-icon-download svg { width:0.7rem; height:0.7rem; display:block; }
    .single-wrap { padding:1rem; }
    .single-preview { border:1px solid var(--border); border-radius:0.8rem; background:#fff; overflow:hidden; min-height:260px; }
    .preview-frame { width:100%; aspect-ratio:4/3; display:flex; align-items:center; justify-content:center; overflow:hidden; }
    .preview-frame img { width:100%; height:100%; object-fit:contain; display:block; }
    .single-actions { display:flex; justify-content:flex-end; margin-top:0.65rem; }
    .file-download { display:inline-block; text-decoration:none; font-size:0.76rem; font-weight:600; color:#fff; background:var(--terra); border-radius:0.5rem; padding:0.45rem 0.62rem; }
    .file-browser { display:flex; height:100%; overflow:hidden; }
    .file-list { width:220px; flex:0 0 220px; border-right:1px solid var(--border); overflow-y:auto; min-height:0; padding:0.7rem; background:#fcfaf7; }
    .file-list-item { width:100%; text-align:left; background:white; border:1px solid var(--border); border-radius:0.62rem; padding:0.62rem; margin-bottom:0.5rem; cursor:pointer; transition:border-color .14s ease, box-shadow .14s ease, background-color .14s ease; }
    .file-list-item:hover { border-color:var(--terra); background:#fffaf6; box-shadow:0 2px 10px rgba(26,22,20,0.08); }
    .file-list-item:focus-visible { outline:none; border-color:var(--terra); box-shadow:0 0 0 2px rgba(196,102,58,0.24); }
    .file-list-item.active { border-color:var(--terra); box-shadow:0 0 0 1px rgba(196,102,58,0.22); }
    .file-list-row { display:flex; align-items:center; gap:0.4rem; min-width:0; }
    .file-list-name { display:block; color:var(--ink); font-size:0.79rem; line-height:1.25; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; min-width:0; flex:1; }
    .file-list-meta { display:flex; justify-content:space-between; gap:0.5rem; color:var(--ink-muted); font-size:0.7rem; margin-top:0.25rem; }
    .viewer { flex:1; min-width:0; display:flex; flex-direction:column; overflow:hidden; height:100%; }
    .viewer-body { flex:1; min-height:0; overflow:hidden; display:flex; align-items:center; justify-content:center; }
    .viewer-body .preview-frame { width:auto; aspect-ratio:unset; max-width:100%; max-height:100%; }
    .viewer-body .preview-frame img { max-width:100%; max-height:100%; width:auto; height:auto; object-fit:contain; }
    .download-bar { border-top:1px solid var(--border); padding:0.95rem 1.05rem; background:#fff; }
    .download-password-label { display:block;font-size:0.75rem;font-weight:600;color:#5C534A;text-transform:uppercase;letter-spacing:.08em;margin-bottom:0.4rem; }
    .download-password-input { width:100%;padding:0.7rem 0.8rem;border:1px solid #E5DFD7;border-radius:0.5rem;margin-bottom:0.6rem;font-size:0.875rem; }
    .download-error { color:#7a3f20;font-size:0.75rem;margin-bottom:0.6rem;padding:0.55rem;border-radius:0.5rem;background:#f6e5dc;border:1px solid #e8c8b5; }
    .download-button { display:inline-block;width:100%;padding:0.78rem 1.5rem;background:#C4663A;color:white;border:none;border-radius:0.55rem;font-size:0.88rem;font-weight:600;text-align:center;text-decoration:none;cursor:pointer; }

    @@media (max-width: 920px) {
      body { padding:1rem; }
      .preview-shell { width:100%; max-height:none; }
      .file-browser { flex-direction:column; }
      .file-list { width:100%; flex:0 0 auto; max-height:220px; border-right:none; border-bottom:1px solid var(--border); }
      .preview-frame { max-height:56vh; }
    }
  </style>
</head>
<body>
  @if (Model.Share is not null)
  {
    @if (Model.HasPreviewExperience)
    {
      <section class="preview-shell">
        <header class="preview-header">
          <h1 class="preview-title">@Model.DisplayH1</h1>
          @if (!string.IsNullOrWhiteSpace(Model.Share.PageTitle))
          {
            <p class="preview-subtitle">@Model.Share.PageTitle</p>
          }
          @if (!string.IsNullOrWhiteSpace(Model.Share.PageDescription))
          {
            <p class="preview-description">@Model.Share.PageDescription</p>
          }
          <p class="preview-description" style="margin-top:0.45rem;">@Model.Share.Files.Count @(Model.Share.Files.Count == 1 ? "file" : "files") Â· @Model.SizeDisplay</p>
        </header>

        <div class="preview-content @(Model.IsMixedFilePreview ? "mixed" : string.Empty)">
          @if (Model.IsImageMosaicPreview)
          {
            <div class="mosaic-grid">
              @foreach (var item in Model.PreviewItems)
              {
                <div class="mosaic-item" title="@item.OriginalFilename">
                  <a class="mosaic-open" href="@item.PreviewImageUrl" target="_blank" rel="noreferrer">
                    <img
                      src="@item.ThumbnailUrl"
                      alt="@item.OriginalFilename"
                      loading="lazy"
                      data-preview-image
                      data-preview-url="@item.ThumbnailUrl"
                      data-preview-status-url="@item.PreviewStatusUrl"
                      data-preview-retry-url="@item.RetryPreviewUrl"
                      data-preview-mode="thumbnail" />
                  </a>
                  <span class="mosaic-meta">
                    <a class="file-icon-download" href="@item.DownloadUrl" title="Download @item.OriginalFilename" aria-label="Download @item.OriginalFilename">
                      <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <path d="M12 4v10m0 0l4-4m-4 4l-4-4M5 18h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                      </svg>
                    </a>
                    <span class="mosaic-label">@item.OriginalFilename</span>
                  </span>
                </div>
              }
            </div>
          }
          else if (Model.IsSingleFilePreview && Model.InitialPreviewItem is not null)
          {
            var item = Model.InitialPreviewItem;
            <div class="single-wrap">
              <div class="single-preview">
                <div class="preview-frame">
                  <img
                    src="@item.PreviewImageUrl"
                    alt="@item.OriginalFilename preview"
                    loading="lazy"
                    data-preview-image
                    data-preview-url="@item.PreviewImageUrl"
                    data-preview-status-url="@item.PreviewStatusUrl"
                    data-preview-retry-url="@item.RetryPreviewUrl"
                    data-preview-mode="full" />
                </div>
              </div>
              <div class="single-actions">
                <a class="file-download" href="@item.DownloadUrl">Download file</a>
              </div>
            </div>
          }
          else if (Model.IsMixedFilePreview)
          {
            <div class="file-browser bg-blue-600" data-file-browser>
              <aside class="file-list">
                @foreach (var item in Model.PreviewItems)
                {
                  <div
                    class="file-list-item @(item.Id == Model.InitialPreviewItem?.Id ? "active" : string.Empty)"
                    tabindex="0"
                    role="button"
                    data-preview-select
                    data-preview-image-url="@item.PreviewImageUrl"
                    data-preview-status-url="@item.PreviewStatusUrl"
                    data-preview-retry-url="@item.RetryPreviewUrl"
                    data-file-url="@item.FileUrl"
                    data-download-url="@item.DownloadUrl"
                    data-kind="@item.PreviewKind"
                    data-name="@item.OriginalFilename"
                    data-size="@item.SizeDisplay"
                    data-ext="@item.ExtensionLabel"
                    title="Preview @item.OriginalFilename"
                    aria-label="Preview @item.OriginalFilename">
                    <span class="file-list-row">
                      <a class="file-icon-download" href="@item.DownloadUrl" title="Download @item.OriginalFilename" aria-label="Download @item.OriginalFilename">
                        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                          <path d="M12 4v10m0 0l4-4m-4 4l-4-4M5 18h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                      </a>
                      <span class="file-list-name">@item.OriginalFilename</span>
                    </span>
                    <span class="file-list-meta">
                      <span>@item.ExtensionLabel</span>
                      <span>@item.SizeDisplay</span>
                    </span>
                  </div>
                }
              </aside>
              <section class="viewer" data-preview-viewer>
                <div class="viewer-body" data-preview-body>
                  @if (Model.InitialPreviewItem is not null)
                  {
                    <div class="preview-frame">
                      <img
                        src="@Model.InitialPreviewItem.PreviewImageUrl"
                        alt="@Model.InitialPreviewItem.OriginalFilename preview"
                        loading="lazy"
                        data-preview-image
                        data-preview-url="@Model.InitialPreviewItem.PreviewImageUrl"
                        data-preview-status-url="@Model.InitialPreviewItem.PreviewStatusUrl"
                        data-preview-retry-url="@Model.InitialPreviewItem.RetryPreviewUrl"
                        data-preview-mode="full" />
                    </div>
                  }
                </div>
              </section>
            </div>
          }
        </div>

        <footer class="download-bar">
          @if (Model.IsExpired || !Model.AllowsZipDownload)
          {
            <button type="button" class="download-button" disabled style="opacity:.6;cursor:not-allowed;" title="@(Model.IsExpired ? "This link has expired." : "ZIP download is disabled for this share mode.")">@previewDownloadLabel</button>
          }
          else
          {
            <form method="post" action="/s/@Model.Token/download" style="margin:0;">
              @Html.AntiForgeryToken()
              @if (Model.RequiresPassword)
              {
                <label for="download-password" class="download-password-label">Download password</label>
                <input id="download-password" name="downloadPassword" type="password" required autocomplete="current-password" class="download-password-input" />
              }
              @if (!string.IsNullOrWhiteSpace(Model.DownloadError))
              {
                <p class="download-error">@Model.DownloadError</p>
              }
              <button type="submit" class="download-button">@previewDownloadLabel</button>
            </form>
          }
          <p style="color:var(--ink-muted);font-size:0.6875rem;margin-top:0.7rem;text-align:center;">
            <a href="https://github.com/aduggleby/agora" target="_blank" rel="noreferrer" style="color:inherit;text-decoration:none;">
              Powered by Agora - Self hosted secure file transfer
            </a>
          </p>
        </footer>
      </section>
    }
    else
    {
      @await Html.PartialAsync("/Pages/Shared/_ShareLandingCard.cshtml", cardModel)
      <p style="color:var(--ink-muted);font-size:0.6875rem;margin-top:1.25rem;padding-bottom:0.5rem;text-align:center;">
        <a href="https://github.com/aduggleby/agora" target="_blank" rel="noreferrer" style="color:inherit;text-decoration:none;">
          Powered by Agora - Self hosted secure file transfer
        </a>
      </p>
    }
  }

  <script src="/js/share-download.js"></script>
</body>
</html>
