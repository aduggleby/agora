@page "/admin"
@model Agora.Web.Pages.Admin.IndexModel

<section class="mb-8">
  <h2 class="font-display text-3xl tracking-tight">Manage users</h2>
  <p class="text-ink-muted text-sm mt-1">Manage users and registration policy.</p>
</section>
<section class="mb-8">
  <form method="post" action="/admin/settings/registration">
    <label class="inline-flex items-center gap-3 cursor-pointer select-none">
      <input type="hidden" name="enabled" value="false" />
      <input type="checkbox" name="enabled" value="true" @(Model.AllowRegistration ? "checked" : "") class="peer sr-only" data-registration-toggle />
      <span class="relative w-11 h-6 rounded-full bg-ink-muted/40 transition-colors peer-checked:bg-sage">
        <span class="absolute left-0.5 top-0.5 h-5 w-5 rounded-full bg-white transition-transform peer-checked:translate-x-5"></span>
      </span>
      <span class="text-sm text-ink-light">Allow new user registration</span>
      <span class="text-xs @(Model.AllowRegistration ? "bg-sage-wash text-sage" : "bg-cream-dark text-ink-muted") px-2 py-0.5 rounded-md">@(Model.AllowRegistration ? "Open" : "Closed")</span>
    </label>
  </form>
</section>
<section>
  <div class="bg-white rounded-2xl border border-border overflow-hidden">
    <div class="px-5 py-3 border-b border-border bg-cream-dark/50 flex items-center justify-between">
      <h3 class="font-display text-lg">Users</h3>
      <span class="text-xs text-ink-muted">@Model.Users.Count total</span>
    </div>
    <table class="w-full">
      <thead>
        <tr class="text-xs font-medium text-ink-muted uppercase tracking-wider border-b border-border">
          <th class="text-left px-4 py-2">Email</th>
          <th class="text-left px-4 py-2">Role</th>
          <th class="text-right px-4 py-2">Actions</th>
        </tr>
      </thead>
      <tbody>
      @foreach (var user in Model.Users)
      {
        <tr class="border-b border-border/60 hover:bg-cream-dark/50 transition-colors">
          <td class="px-4 py-3 text-sm">
            <span>@user.Email</span>
            <span class="ml-2 inline-flex items-center rounded-md bg-cream-dark px-2 py-0.5 text-[11px] font-medium text-ink-muted @(user.IsEnabled ? "hidden" : string.Empty)" data-user-disabled-badge>Disabled</span>
          </td>
          <td class="px-4 py-3">
            @if (user.Id.ToString().Equals(Model.CurrentUserId, StringComparison.OrdinalIgnoreCase))
            {
              <select class="text-xs px-2 py-1 border border-border rounded-md bg-cream text-ink-muted cursor-not-allowed" disabled title="You cannot change your own role.">
                <option value="user" selected="@(user.Role == "user")">user</option>
                <option value="admin" selected="@(user.Role == "admin")">admin</option>
              </select>
            }
            else
            {
              <select class="text-xs px-2 py-1 border border-border rounded-md bg-cream focus:outline-none focus:border-terra" data-user-role-select data-user-id="@user.Id" data-current-role="@user.Role">
                  <option value="user" selected="@(user.Role == "user")">user</option>
                  <option value="admin" selected="@(user.Role == "admin")">admin</option>
              </select>
            }
          </td>
          <td class="px-4 py-3 text-right">
            <div class="flex items-center justify-end gap-3">
              <button
                type="button"
                class="text-xs @(user.IsEnabled ? "text-ink-muted hover:text-danger" : "text-sage hover:underline")"
                data-user-enabled-toggle
                data-user-id="@user.Id"
                data-next-enabled="@(!user.IsEnabled).ToString().ToLowerInvariant()">
                @(user.IsEnabled ? "Disable" : "Enable")
              </button>
              @if (user.Email == Model.CurrentUserEmail)
              {
                <span class="text-xs text-ink-muted">(you)</span>
              }
              else
              {
                <form method="post" action="/admin/users/@user.Id/delete" class="inline" data-confirm-submit="Delete this user?">
                  <button type="submit" class="text-xs text-danger hover:underline">Delete</button>
                </form>
              }
            </div>
          </td>
        </tr>
      }
      </tbody>
    </table>
  </div>
</section>

<div class="fixed right-5 bottom-5 z-50 pointer-events-none hidden" data-admin-toast></div>

<script src="/js/admin-index.js"></script>
