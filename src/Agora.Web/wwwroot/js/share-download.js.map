{
  "version": 3,
  "sources": ["../../scripts/ts/share-download.ts"],
  "sourcesContent": ["type PreviewStatusResponse = {\n  state?: string;\n  reason?: string;\n  previewUrl?: string;\n  thumbnailUrl?: string;\n  retryUrl?: string;\n};\n\n(() => {\n  const maxAutoRetryMs = 5 * 60 * 1000;\n  const autoRetryIntervalMs = 15 * 1000;\n  const imageRetryIntervalMs = 2500;\n\n  const toSafeHtml = (value: string): string =>\n    value.replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('\"', '&quot;');\n\n  const attachPreviewLifecycle = (img: HTMLImageElement): void => {\n    const statusUrl = img.dataset.previewStatusUrl || '';\n    const initialPreviewUrl = img.dataset.previewUrl || img.getAttribute('src') || '';\n    let retryUrl = img.dataset.previewRetryUrl || '';\n    let currentPreviewUrl = initialPreviewUrl;\n    if (!statusUrl || !initialPreviewUrl) return;\n\n    const frame = img.closest<HTMLElement>('.preview-frame');\n    if (!frame) return;\n    if (frame.dataset.previewLifecycleAttached === '1') return;\n    frame.dataset.previewLifecycleAttached = '1';\n    frame.style.position = 'relative';\n\n    const placeholder = document.createElement('div');\n    placeholder.className = 'preview-loading-placeholder';\n    placeholder.style.display = 'none';\n    frame.appendChild(placeholder);\n\n    const panel = document.createElement('div');\n    panel.className = 'hidden';\n    panel.style.position = 'absolute';\n    panel.style.right = '0.6rem';\n    panel.style.bottom = '0.6rem';\n    panel.style.display = 'none';\n    panel.style.gap = '0.5rem';\n    panel.style.alignItems = 'center';\n    panel.style.background = 'rgba(255,255,255,0.92)';\n    panel.style.border = '1px solid #E5DFD7';\n    panel.style.borderRadius = '999px';\n    panel.style.padding = '0.3rem 0.45rem 0.3rem 0.6rem';\n    panel.style.boxShadow = '0 2px 10px rgba(26,22,20,0.09)';\n\n    const label = document.createElement('span');\n    label.style.fontSize = '0.7rem';\n    label.style.color = '#5C534A';\n    label.textContent = 'Preparing preview...';\n\n    const button = document.createElement('button');\n    button.type = 'button';\n    button.textContent = 'Retry';\n    button.style.border = '1px solid #E5DFD7';\n    button.style.borderRadius = '999px';\n    button.style.padding = '0.2rem 0.5rem';\n    button.style.background = '#FAF7F2';\n    button.style.color = '#1A1614';\n    button.style.fontSize = '0.68rem';\n    button.style.cursor = 'pointer';\n\n    panel.append(label, button);\n    frame.appendChild(panel);\n\n    let startedAt = Date.now();\n    let timer: number | null = null;\n    let imageRetryTimer: number | null = null;\n    let active = true;\n\n    const setPanel = (message: string, showRetry: boolean): void => {\n      label.textContent = message;\n      button.style.display = showRetry ? '' : 'none';\n      panel.style.display = '';\n    };\n\n    const clearPanel = (): void => {\n      panel.style.display = 'none';\n    };\n\n    const showPlaceholder = (): void => {\n      placeholder.style.display = '';\n      img.style.visibility = 'hidden';\n    };\n\n    const hidePlaceholder = (): void => {\n      placeholder.style.display = 'none';\n      img.style.visibility = 'visible';\n    };\n\n    const setImageSource = (url: string): void => {\n      currentPreviewUrl = url;\n      const separator = url.includes('?') ? '&' : '?';\n      img.src = `${url}${separator}v=${Date.now()}`;\n    };\n\n    const clearImageRetry = (): void => {\n      if (imageRetryTimer) {\n        window.clearTimeout(imageRetryTimer);\n        imageRetryTimer = null;\n      }\n    };\n\n    const probePreviewImage = async (): Promise<'ready' | 'not_found' | 'error'> => {\n      const requestUrl = `${currentPreviewUrl}${currentPreviewUrl.includes('?') ? '&' : '?'}v=${Date.now()}`;\n      try {\n        let response = await fetch(requestUrl, {\n          method: 'HEAD',\n          cache: 'no-store',\n          credentials: 'same-origin'\n        });\n\n        if (response.status === 405) {\n          response = await fetch(requestUrl, {\n            method: 'GET',\n            cache: 'no-store',\n            credentials: 'same-origin'\n          });\n        }\n\n        if (response.ok) return 'ready';\n        if (response.status === 404) return 'not_found';\n        return 'error';\n      } catch {\n        return 'error';\n      }\n    };\n\n    const scheduleImageRetry = (): void => {\n      if (!active) return;\n      clearImageRetry();\n      imageRetryTimer = window.setTimeout(async () => {\n        const result = await probePreviewImage();\n        if (result === 'ready') {\n          setImageSource(currentPreviewUrl);\n          return;\n        }\n\n        showPlaceholder();\n        setPanel('Preparing preview...', false);\n        scheduleImageRetry();\n      }, imageRetryIntervalMs);\n    };\n\n    const scheduleNext = (): void => {\n      if (!active) return;\n      timer = window.setTimeout(() => void refresh(), autoRetryIntervalMs);\n    };\n\n    const refresh = async (): Promise<void> => {\n      if (!active) return;\n\n      try {\n        const response = await fetch(`${statusUrl}${statusUrl.includes('?') ? '&' : '?'}_=${Date.now()}`, {\n          method: 'GET',\n          cache: 'no-store',\n          credentials: 'same-origin'\n        });\n        if (!response.ok) {\n          setPanel('Unable to check preview status.', true);\n          return;\n        }\n\n        const status = (await response.json()) as PreviewStatusResponse;\n        const state = (status.state || '').trim().toLowerCase();\n        const reason = (status.reason || '').trim().toLowerCase();\n        retryUrl = status.retryUrl || retryUrl;\n\n        if (img.dataset.previewMode === 'thumbnail' && status.thumbnailUrl) {\n          setImageSource(status.thumbnailUrl);\n        } else if (status.previewUrl) {\n          setImageSource(status.previewUrl);\n        } else {\n          setImageSource(initialPreviewUrl);\n        }\n\n        if (state === 'ready') {\n          clearImageRetry();\n          clearPanel();\n          return;\n        }\n\n        if (state === 'pending') {\n          const elapsed = Date.now() - startedAt;\n          if (elapsed <= maxAutoRetryMs) {\n            setPanel('Preparing preview...', false);\n            scheduleNext();\n          } else {\n            setPanel('Still preparing. You can retry now.', true);\n          }\n          return;\n        }\n\n        if (reason === 'unsupported_type') {\n          clearImageRetry();\n          hidePlaceholder();\n          setPanel('Preview cannot be shown for this file type.', false);\n        } else {\n          setPanel('Preview unavailable. Retry generation.', true);\n        }\n      } catch {\n        setPanel('Unable to check preview status.', true);\n      }\n    };\n\n    button.addEventListener('click', async () => {\n      if (!retryUrl) {\n        setPanel('Retry URL unavailable.', false);\n        return;\n      }\n\n      button.disabled = true;\n      label.textContent = 'Retry requested...';\n      try {\n        await fetch(`${retryUrl}${retryUrl.includes('?') ? '&' : '?'}_=${Date.now()}`, {\n          method: 'GET',\n          cache: 'no-store',\n          credentials: 'same-origin'\n        });\n        startedAt = Date.now();\n        button.disabled = false;\n        showPlaceholder();\n        scheduleImageRetry();\n        setPanel('Preparing preview...', false);\n        if (timer) window.clearTimeout(timer);\n        scheduleNext();\n      } catch {\n        button.disabled = false;\n        setPanel('Retry failed. Try again.', true);\n      }\n    });\n\n    img.addEventListener('load', () => {\n      hidePlaceholder();\n      clearImageRetry();\n      clearPanel();\n    });\n\n    img.addEventListener('error', () => {\n      showPlaceholder();\n      setPanel('Preparing preview...', false);\n      scheduleImageRetry();\n    });\n\n    void refresh();\n  };\n\n  document.querySelectorAll<HTMLImageElement>('img[data-preview-image]').forEach((img) => {\n    attachPreviewLifecycle(img);\n  });\n\n  const browser = document.querySelector<HTMLElement>('[data-file-browser]');\n  if (!browser) return;\n\n  const items = Array.from(browser.querySelectorAll<HTMLElement>('[data-preview-select]'));\n  const body = browser.querySelector<HTMLElement>('[data-preview-body]');\n  if (!body) return;\n\n  const renderPreviewImage = (previewImageUrl: string, fileName: string, statusUrl: string, retryUrl: string): string => {\n    const alt = toSafeHtml(fileName);\n    const imageUrl = toSafeHtml(previewImageUrl);\n    const safeStatusUrl = toSafeHtml(statusUrl);\n    const safeRetryUrl = toSafeHtml(retryUrl);\n    return `<div class=\"preview-frame\"><img src=\"${imageUrl}\" alt=\"${alt} preview\" loading=\"lazy\" data-preview-image data-preview-url=\"${imageUrl}\" data-preview-status-url=\"${safeStatusUrl}\" data-preview-retry-url=\"${safeRetryUrl}\" data-preview-mode=\"full\" /></div>`;\n  };\n\n  const activateItem = (item: HTMLElement): void => {\n    items.forEach((node) => node.classList.remove('active'));\n    item.classList.add('active');\n\n    const previewImageUrl = item.dataset.previewImageUrl || '';\n    const previewStatusUrl = item.dataset.previewStatusUrl || '';\n    const previewRetryUrl = item.dataset.previewRetryUrl || '';\n    const fileName = item.dataset.name || 'File';\n    body.innerHTML = renderPreviewImage(previewImageUrl, fileName, previewStatusUrl, previewRetryUrl);\n\n    const nextImage = body.querySelector<HTMLImageElement>('img[data-preview-image]');\n    if (nextImage) {\n      attachPreviewLifecycle(nextImage);\n    }\n  };\n\n  items.forEach((item) => {\n    item.addEventListener('click', (event) => {\n      const target = event.target as HTMLElement | null;\n      if (target?.closest('.file-icon-download')) return;\n      activateItem(item);\n    });\n\n    item.addEventListener('keydown', (event) => {\n      if (event.key !== 'Enter' && event.key !== ' ') return;\n      event.preventDefault();\n      activateItem(item);\n    });\n  });\n})();\n"],
  "mappings": "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",
  "names": []
}
