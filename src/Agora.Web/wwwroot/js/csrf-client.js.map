{
  "version": 3,
  "sources": ["../../scripts/ts/csrf-client.ts"],
  "sourcesContent": ["type CsrfAwareXhr = XMLHttpRequest & {\n  _csrfMethod?: string;\n  _csrfUrl?: string;\n};\n\n(() => {\n  const cookieName = 'agora.csrf.request';\n  const formFieldName = '__RequestVerificationToken';\n  const headerName = 'X-CSRF-TOKEN';\n\n  const getCookie = (name: string): string => {\n    const prefix = `${name}=`;\n    const parts = document.cookie ? document.cookie.split(';') : [];\n    for (const part of parts) {\n      const value = part.trim();\n      if (value.startsWith(prefix)) {\n        return decodeURIComponent(value.slice(prefix.length));\n      }\n    }\n    return '';\n  };\n\n  const csrfToken = getCookie(cookieName);\n  if (!csrfToken) return;\n\n  const isUnsafeMethod = (method: string | undefined | null): boolean => {\n    const upper = (method || 'GET').toUpperCase();\n    return upper !== 'GET' && upper !== 'HEAD' && upper !== 'OPTIONS' && upper !== 'TRACE';\n  };\n\n  const isSameOriginUrl = (input: string | URL | undefined | null): boolean => {\n    try {\n      const url = new URL(input || window.location.href, window.location.href);\n      return url.origin === window.location.origin;\n    } catch {\n      return false;\n    }\n  };\n\n  document.querySelectorAll<HTMLFormElement>('form').forEach((form) => {\n    const method = form.getAttribute('method') || 'GET';\n    if (!isUnsafeMethod(method)) return;\n    if (form.querySelector(`input[name=\"${formFieldName}\"]`)) return;\n\n    const input = document.createElement('input');\n    input.type = 'hidden';\n    input.name = formFieldName;\n    input.value = csrfToken;\n    form.appendChild(input);\n  });\n\n  const originalFetch = window.fetch.bind(window);\n  window.fetch = (input: RequestInfo | URL, init?: RequestInit): Promise<Response> => {\n    const method = init?.method || 'GET';\n    const url = typeof input === 'string' || input instanceof URL ? String(input) : input.url;\n\n    if (!isUnsafeMethod(method) || !isSameOriginUrl(url)) {\n      return originalFetch(input, init);\n    }\n\n    const requestInit: RequestInit = init ? { ...init } : {};\n    const headers = new Headers(requestInit.headers || (input instanceof Request ? input.headers : undefined));\n    if (!headers.has(headerName)) {\n      headers.set(headerName, csrfToken);\n    }\n    requestInit.headers = headers;\n\n    return originalFetch(input, requestInit);\n  };\n\n  const originalOpen = XMLHttpRequest.prototype.open;\n  const originalSend = XMLHttpRequest.prototype.send;\n\n  XMLHttpRequest.prototype.open = function(\n    this: CsrfAwareXhr,\n    method: string,\n    url: string | URL,\n    async?: boolean,\n    username?: string | null,\n    password?: string | null\n  ): void {\n    this._csrfMethod = method || 'GET';\n    this._csrfUrl = String(url || window.location.href);\n    originalOpen.call(this, method, String(url), async ?? true, username ?? null, password ?? null);\n  };\n\n  XMLHttpRequest.prototype.send = function(this: CsrfAwareXhr, body?: Document | XMLHttpRequestBodyInit | null): void {\n    if (isUnsafeMethod(this._csrfMethod) && isSameOriginUrl(this._csrfUrl)) {\n      this.setRequestHeader(headerName, csrfToken);\n    }\n    originalSend.call(this, body ?? null);\n  };\n})();\n"],
  "mappings": ";;;AAKA,GAAC,MAAM;AACL,UAAM,aAAa;AACnB,UAAM,gBAAgB;AACtB,UAAM,aAAa;AAEnB,UAAM,YAAY,CAAC,SAAyB;AAC1C,YAAM,SAAS,GAAG,IAAI;AACtB,YAAM,QAAQ,SAAS,SAAS,SAAS,OAAO,MAAM,GAAG,IAAI,CAAC;AAC9D,iBAAW,QAAQ,OAAO;AACxB,cAAM,QAAQ,KAAK,KAAK;AACxB,YAAI,MAAM,WAAW,MAAM,GAAG;AAC5B,iBAAO,mBAAmB,MAAM,MAAM,OAAO,MAAM,CAAC;AAAA,QACtD;AAAA,MACF;AACA,aAAO;AAAA,IACT;AAEA,UAAM,YAAY,UAAU,UAAU;AACtC,QAAI,CAAC,UAAW;AAEhB,UAAM,iBAAiB,CAAC,WAA+C;AACrE,YAAM,SAAS,UAAU,OAAO,YAAY;AAC5C,aAAO,UAAU,SAAS,UAAU,UAAU,UAAU,aAAa,UAAU;AAAA,IACjF;AAEA,UAAM,kBAAkB,CAAC,UAAoD;AAC3E,UAAI;AACF,cAAM,MAAM,IAAI,IAAI,SAAS,OAAO,SAAS,MAAM,OAAO,SAAS,IAAI;AACvE,eAAO,IAAI,WAAW,OAAO,SAAS;AAAA,MACxC,QAAQ;AACN,eAAO;AAAA,MACT;AAAA,IACF;AAEA,aAAS,iBAAkC,MAAM,EAAE,QAAQ,CAAC,SAAS;AACnE,YAAM,SAAS,KAAK,aAAa,QAAQ,KAAK;AAC9C,UAAI,CAAC,eAAe,MAAM,EAAG;AAC7B,UAAI,KAAK,cAAc,eAAe,aAAa,IAAI,EAAG;AAE1D,YAAM,QAAQ,SAAS,cAAc,OAAO;AAC5C,YAAM,OAAO;AACb,YAAM,OAAO;AACb,YAAM,QAAQ;AACd,WAAK,YAAY,KAAK;AAAA,IACxB,CAAC;AAED,UAAM,gBAAgB,OAAO,MAAM,KAAK,MAAM;AAC9C,WAAO,QAAQ,CAAC,OAA0B,SAA0C;AAClF,YAAM,SAAS,MAAM,UAAU;AAC/B,YAAM,MAAM,OAAO,UAAU,YAAY,iBAAiB,MAAM,OAAO,KAAK,IAAI,MAAM;AAEtF,UAAI,CAAC,eAAe,MAAM,KAAK,CAAC,gBAAgB,GAAG,GAAG;AACpD,eAAO,cAAc,OAAO,IAAI;AAAA,MAClC;AAEA,YAAM,cAA2B,OAAO,EAAE,GAAG,KAAK,IAAI,CAAC;AACvD,YAAM,UAAU,IAAI,QAAQ,YAAY,YAAY,iBAAiB,UAAU,MAAM,UAAU,OAAU;AACzG,UAAI,CAAC,QAAQ,IAAI,UAAU,GAAG;AAC5B,gBAAQ,IAAI,YAAY,SAAS;AAAA,MACnC;AACA,kBAAY,UAAU;AAEtB,aAAO,cAAc,OAAO,WAAW;AAAA,IACzC;AAEA,UAAM,eAAe,eAAe,UAAU;AAC9C,UAAM,eAAe,eAAe,UAAU;AAE9C,mBAAe,UAAU,OAAO,SAE9B,QACA,KACA,OACA,UACA,UACM;AACN,WAAK,cAAc,UAAU;AAC7B,WAAK,WAAW,OAAO,OAAO,OAAO,SAAS,IAAI;AAClD,mBAAa,KAAK,MAAM,QAAQ,OAAO,GAAG,GAAG,SAAS,MAAM,YAAY,MAAM,YAAY,IAAI;AAAA,IAChG;AAEA,mBAAe,UAAU,OAAO,SAA6B,MAAuD;AAClH,UAAI,eAAe,KAAK,WAAW,KAAK,gBAAgB,KAAK,QAAQ,GAAG;AACtE,aAAK,iBAAiB,YAAY,SAAS;AAAA,MAC7C;AACA,mBAAa,KAAK,MAAM,QAAQ,IAAI;AAAA,IACtC;AAAA,EACF,GAAG;",
  "names": []
}
